<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Lesson 6 â€” Short Vowel i in Closed Syllables"/>
  <title>Mini OpenStax â€” Lesson 6: Short Vowel i</title>
  <link rel="stylesheet" href="../css/chat.css" />
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Lesson 6: Short Vowel i</h1>
        <div class="lo-tags" id="lo-tags">LO PH6: Decode closed-syllable CVC words with short i (/Ä­/)</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content" role="main">
      <!-- WhatsApp Feature Integration -->
      <div class="whatsapp-hint">
        ğŸ’¬ <strong>Learn like you chat!</strong> Say it with voice notes, share ideas with your group, and send progress reportsâ€”all with the safety and privacy of WhatsApp.
      </div>

      <div class="section">
        <h2>ğŸ”¤ Word List</h2>
        <p>Short <strong>i</strong> (/Ä­/) in closed syllables:</p>
        <div class="word-list" id="word-list"></div>
      </div>

      <div class="section">
        <h2>ğŸ“– Practice Sentences</h2>
        <p>Read aloudâ€”or record a <strong>voice note</strong> like on WhatsApp!</p>
        <div class="sentences" id="sentences"></div>
      </div>

      <!-- GROUP SECTION -->
      <div class="section" id="group-section" style="display:none;">
        <h2>ğŸ‘¥ Your Learning Group</h2>
        <div id="group-display"></div>
        <button type="button" class="btn" id="join-group-btn">â• Join or Create Group</button>
      </div>

      <!-- REFLECTION -->
      <div class="section" id="reflection-prompt" style="display:none;">
        <h2>ğŸ’¡ Reflect & Apply</h2>
        <p id="reflection-question">How could you use words like â€œwig,â€ â€œzip,â€ or â€œwinâ€ in a real message to a friend?</p>
        <textarea id="reflection-response" placeholder="Write 1â€“2 sentences... (Share with your group like a WhatsApp message!)" rows="3"></textarea>
        <div class="button-row">
          <button type="button" class="btn" id="save-reflection">ğŸ’¾ Save & Share with Group</button>
          <button type="button" class="btn btn-secondary" id="view-peer-reflections">ğŸ‘€ See Peer Ideas</button>
          <button type="button" class="btn" id="export-group-data">ğŸ“¤ Export My Insights</button>
          <button type="button" class="btn btn-secondary" id="import-peer-data">ğŸ“¥ Import Peer Insights</button>
        </div>
        <div id="import-area" style="display:none; margin-top:0.5rem;">
          <textarea id="import-text" placeholder="Paste data received via WhatsApp here..." rows="3"></textarea>
          <button type="button" class="btn" id="do-import" style="margin-top:0.3rem;">âœ“ Apply</button>
        </div>
        <div id="peer-reflections" style="margin-top:1rem; display:none;"></div>
      </div>

      <!-- NAME PROMPT -->
      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>ğŸ‘¤ Your Name</h2>
        <input type="text" id="student-name" placeholder="Enter your name (e.g., Ama K.)" maxlength="30"/>
        <div id="name-buttons" style="margin-top:0.5rem;"></div>
        <div class="whatsapp-hint" style="margin-top:1rem;">
          ğŸ”’ <strong>Your data is private.</strong> Reports are sent only when you chooseâ€”securely via WhatsApp.
        </div>
      </div>

      <!-- QUIZ -->
      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>ğŸ“ Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">âœ¨ Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">ğŸ“¤ Send Anonymous Usage Data via WhatsApp</a>
        <br>
        <a href="../index.html">ğŸ  Back to Dashboard</a>
      </footer>
    </main>
  </div>

  <script type="module">
    import { initNamePrompt } from '../js/chatUI.js';
    import { initGroupSection, initReflectionUI } from '../js/chatUI.js';
    import { logEvent, evaluateQuiz, generateQuizReport, shareViaWhatsApp } from '../js/chatLogic.js';

    const currentChapter = 5;
    const MAX_CHAPTER = 262;
    window.CHAPTER_CONFIG = {
      title: "Lesson 6: Short Vowel i",
      loTags: ["LO PH6: Decode closed-syllable CVC words with short i (/Ä­/)"],
      contentWords: [
        "rib", "rid", "rig", "rim", "rip", "pig", "pin", "pit", "lid", "lip", "lit", "Liz",
        "tin", "tip", "tic", "Tim", "jig", "Jim", "kid", "kit", "kin", "Kim",
        "wig", "win", "wit", "Vic", "vim", "nip", "zip", "yip"
      ],
      sentences: [
        "Jim had a fat lip.",
        "The cap had a rip in it.",
        "Did the big wig fit Liz?",
        "A big pig did a jig in a pit.",
        "A big lid can fit a big pan.",
        "A lid can tip. A lid can hit a rim.",
        "Did the rat nip the cat in a rib?",
        "Did the cat yip? Did the rat zip?",
        "Vic had wit. Vic had vim. Vic can win!"
      ],
      reflectionPrompt: "How could you use words like â€œwig,â€ â€œzip,â€ or â€œwinâ€ in a real message to a friend?",
      assessmentItems: [
        { id: "1", prompt: "Which word has a short /Ä­/ sound?", options: [{id:"a",text:"wig",is_correct:true},{id:"b",text:"wag",is_correct:false},{id:"c",text:"wog",is_correct:false},{id:"d",text:"weg",is_correct:false}] },
        { id: "2", prompt: "How many letters in 'zip'?", options: [{id:"a",text:"3",is_correct:true},{id:"b",text:"2",is_correct:false},{id:"c",text:"4",is_correct:false},{id:"d",text:"1",is_correct:false}] },
        { id: "3", prompt: "Which word means 'to close quickly with a fastener'?", options: [{id:"a",text:"zip",is_correct:true},{id:"b",text:"zap",is_correct:false},{id:"c",text:"zop",is_correct:false},{id:"d",text:"zup",is_correct:false}] },
        { id: "4", prompt: "What syllable type is 'kid'?", options: [{id:"a",text:"Closed syllable",is_correct:true},{id:"b",text:"Open syllable",is_correct:false},{id:"c",text:"Magic E",is_correct:false},{id:"d",text:"Vowel team",is_correct:false}] },
        { id: "5", prompt: "Which sentence is from Lesson 6?", options: [{id:"a",text:"Jim had a fat lip.",is_correct:true},{id:"b",text:"She likes apples.",is_correct:false},{id:"c",text:"He flew a kite.",is_correct:false},{id:"d",text:"They played soccer.",is_correct:false}] },
        { id: "6", prompt: "In 'A lid can tip. A lid can hit a rim,' how many short-i words?", options: [{id:"a",text:"5",is_correct:true},{id:"b",text:"3",is_correct:false},{id:"c",text:"4",is_correct:false},{id:"d",text:"2",is_correct:false}] },
        { id: "7", prompt: "Which word rhymes with 'win'?", options: [{id:"a",text:"pin",is_correct:true},{id:"b",text:"pan",is_correct:false},{id:"c",text:"pen",is_correct:false},{id:"d",text:"pun",is_correct:false}] },
        { id: "8", prompt: "Which word might complete: 'Did the big wig fit ___?'", options: [{id:"a",text:"Liz",is_correct:true},{id:"b",text:"Laz",is_correct:false},{id:"c",text:"Loz",is_correct:false},{id:"d",text:"Luz",is_correct:false}] },
        { id: "9", prompt: "How many consonants in 'rip'?", options: [{id:"a",text:"2",is_correct:true},{id:"b",text:"1",is_correct:false},{id:"c",text:"3",is_correct:false},{id:"d",text:"0",is_correct:false}] },
        { id: "10", prompt: "Which word is a name from the sentences?", options: [{id:"a",text:"Jim",is_correct:true},{id:"b",text:"Vic",is_correct:true},{id:"c",text:"Liz",is_correct:true},{id:"d",text:"All of the above",is_correct:true}] },
        { id: "11", prompt: "Which word might complete: 'Vic had ___. Vic had vim.'?", options: [{id:"a",text:"wit",is_correct:true},{id:"b",text:"wat",is_correct:false},{id:"c",text:"wot",is_correct:false},{id:"d",text:"wut",is_correct:false}] },
        { id: "12", prompt: "Which word has the same vowel sound as 'dim'?", options: [{id:"a",text:"rim",is_correct:true},{id:"b",text:"ram",is_correct:false},{id:"c",text:"rum",is_correct:false},{id:"d",text:"rem",is_correct:false}] },
        { id: "13", prompt: "Which sentence includes the word 'jig'?", options: [{id:"a",text:"A big pig did a jig in a pit.",is_correct:true},{id:"b",text:"Jim had a fat lip.",is_correct:false},{id:"c",text:"The cap had a rip.",is_correct:false},{id:"d",text:"Vic had wit.",is_correct:false}] },
        { id: "14", prompt: "How many short-i words in: 'Did the rat nip the cat in a rib?'?", options: [{id:"a",text:"3",is_correct:true},{id:"b",text:"2",is_correct:false},{id:"c",text:"1",is_correct:false},{id:"d",text:"0",is_correct:false}] },
        { id: "15", prompt: "Which word might complete: 'Did the cat ___?'", options: [{id:"a",text:"yip",is_correct:true},{id:"b",text:"yap",is_correct:false},{id:"c",text:"yop",is_correct:false},{id:"d",text:"yup",is_correct:false}] },
        { id: "16", prompt: "What phonics pattern is in 'tip'?", options: [{id:"a",text:"Short i in closed syllable",is_correct:true},{id:"b",text:"Long i",is_correct:false},{id:"c",text:"Magic E",is_correct:false},{id:"d",text:"Consonant blend",is_correct:false}] },
        { id: "17", prompt: "Which word appears in both the word list and sentences?", options: [{id:"a",text:"wig",is_correct:true},{id:"b",text:"zip",is_correct:true},{id:"c",text:"win",is_correct:true},{id:"d",text:"All of the above",is_correct:true}] },
        { id: "18", prompt: "Which word might complete: 'A big ___ did a jig.'?", options: [{id:"a",text:"pig",is_correct:true},{id:"b",text:"pag",is_correct:false},{id:"c",text:"peg",is_correct:false},{id:"d",text:"pug",is_correct:false}] },
        { id: "19", prompt: "The word 'vim' connects to which concept?", options: [{id:"a",text:"Short i in CVC",is_correct:true},{id:"b",text:"Long vowel",is_correct:false},{id:"c",text:"R-controlled",is_correct:false},{id:"d",text:"Silent e",is_correct:false}] },
        { id: "20", prompt: "What is the vowel sound in 'kit'?", options: [{id:"a",text:"/Ä­/ (short i)",is_correct:true},{id:"b",text:"/Ä«/",is_correct:false},{id:"c",text:"/e/",is_correct:false},{id:"d",text:"/o/",is_correct:false}] }
      ]
    };

    // === Rendering Functions ===
    function renderWords() {
      document.getElementById('word-list').innerHTML =
        CHAPTER_CONFIG.contentWords.map(w => `<span class="word-item">${w}</span>`).join('');
    }

    function renderSentences() {
      document.getElementById('sentences').innerHTML =
        CHAPTER_CONFIG.sentences.map(s => `<p>${s}</p>`).join('');
    }

    function renderNavigation() {
      const nav = document.getElementById('chapter-nav');
      const buttons = [{ label: "Home", url: "../index.html", active: false }];
      for (let i = 0; i < 4; i++) {
        const c = currentChapter + i;
        if (c >= MAX_CHAPTER) break;
        buttons.push({
          label: `Lesson ${c + 1}`,
          url: `chapter-${c}.html`,
          active: i === 0
        });
      }
      nav.innerHTML = buttons.map(b =>
        `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
      ).join('');
    }

    function renderQuiz() {
      const form = document.getElementById('quiz-form');
      window.quizCorrectMap = {};
      form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
        const opts = [...q.options].sort(() => Math.random() - 0.5);
        const correct = q.options.find(o => o.is_correct);
        window.quizCorrectMap[q.id] = correct.id;
        const optHtml = opts.map((opt, idx) => {
          const letter = String.fromCharCode(65 + idx);
          return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
        }).join('');
        return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
      }).join('');
    }

    function setupQuizListeners() {
      document.getElementById('submit-quiz').addEventListener('click', () => {
        const form = document.getElementById('quiz-form');
        const answers = [];
        for (let i = 1; i <= 20; i++) {
          const el = form.querySelector(`input[name="q${i}"]:checked`);
          answers.push(el ? el.value : null);
        }
        if (answers.includes(null)) {
          alert("Please answer all questions.");
          return;
        }

        const results = evaluateQuiz(answers, window.quizCorrectMap, CHAPTER_CONFIG.assessmentItems);
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        const reflection = localStorage.getItem(`reflection_${currentChapter}`) || '';

        const report = generateQuizReport(currentChapter, results, timeOnTask, attempts, reflection);
        const masteryMsg = results.mastery
          ? 'ğŸ‰ Excellent! Youâ€™ve mastered short i!'
          : results.score >= 10
            ? 'Good! Review missed items.'
            : 'Keep practicing. Try the word list again.';

        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>ğŸ“Š Results: ${results.score}/20</h3>
            <p><strong>${masteryMsg}</strong></p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <button type="button" class="btn" style="background:#25D366;" onclick="shareViaWhatsApp(\`${report.replace(/`/g, '\\`')}\`)">
              ğŸ“² Send Report via WhatsApp
            </button>
          </div>
        `;
      });
    }

    // === Initialization ===
    window.startTime = Date.now();

    function initLesson() {
      document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
      document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];
      renderNavigation();
      renderWords();
      renderSentences();
      renderQuiz();
      setupQuizListeners();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initNamePrompt(() => {
        initGroupSection(currentChapter);
        initReflectionUI(currentChapter);
      });
      initLesson();

      document.getElementById('send-analytics')?.addEventListener('click', (e) => {
        e.preventDefault();
        if (confirm('Send anonymous usage data to help improve Mini OpenStax?\n\nYour data is safeâ€”sent only via WhatsApp, no personal info shared.')) {
          import('../js/chatLogic.js').then(m => m.sendAnalyticsEvents());
        }
      });
    });
  </script>
</body>
</html>
